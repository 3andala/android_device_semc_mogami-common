From a6aadd5409aa8db802fefaf5355e85220937bc1e Mon Sep 17 00:00:00 2001
From: Pontus Fuchs <pontus.fuchs@gmail.com>
Date: Sun, 4 Dec 2011 08:25:37 +0100
Subject: [PATCH] Fail if fw file does not exist

Fixes a long timeout when trying to load a nonexising fw file.

Change-Id: I22eca83a4eef68d31a3933c0d5a769f89235e973
---
 init/devices.c |    8 ++++++--
 1 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/init/devices.c b/init/devices.c
index e73efdf..92f9bc6 100644
--- a/init/devices.c
+++ b/init/devices.c
@@ -458,8 +458,10 @@ static int load_firmware(int fw_fd, int loading_fd, int data_fd)
     long len_to_copy;
     int ret = 0;
 
-    if(fstat(fw_fd, &st) < 0)
+    if(fstat(fw_fd, &st) < 0) {
+        write(loading_fd, "-1", 2);
         return -1;
+    }
     len_to_copy = st.st_size;
 
     write(loading_fd, "1", 1);  /* start transfer */
@@ -537,8 +539,10 @@ static void process_firmware_event(struct uevent *uevent)
     fw_fd = open(file1, O_RDONLY);
     if(fw_fd < 0) {
         fw_fd = open(file2, O_RDONLY);
-        if(fw_fd < 0)
+        if(fw_fd < 0) {
+            write(loading_fd, "-1", 2);
             goto data_close_out;
+        }
     }
 
     if(!load_firmware(fw_fd, loading_fd, data_fd))
-- 
1.7.5.4

